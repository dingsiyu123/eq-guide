import { NextRequest } from 'next/server';
import { ARENA_LEVELS } from '../../../lib/data';
import { ChatMessage } from '../../../types';

export const runtime = 'edge';

// ç¡…åŸºæµåŠ¨ (SiliconFlow) API é…ç½®
const API_URL = "https://api.siliconflow.cn/v1/chat/completions";
const MODEL_NAME = process.env.MODEL_NAME || "deepseek-ai/DeepSeek-V3.1-Terminus";
const rateLimitMap = new Map<string, number>();

export async function POST(req: NextRequest) {

  const ip = req.headers.get('x-forwarded-for') || 'unknown';
  const now = Date.now();
  const lastRequestTime = rateLimitMap.get(ip) || 0;
  
  // é™åˆ¶ï¼šåŒä¸€ IP 3ç§’å†…åªèƒ½è¯·æ±‚ä¸€æ¬¡
  if (now - lastRequestTime < 3000) {
    return new Response(JSON.stringify({ error: "æ“ä½œå¤ªå¿«äº†ï¼Œè¯·å–å£èŒ¶æ­‡æ­‡" }), { status: 429 });
  }
  rateLimitMap.set(ip, now);
  
  const apiKey = process.env.API_KEY;

  if (!apiKey) {
    return new Response(JSON.stringify({ error: "Missing API Key" }), { status: 500 });
  }

  try {
    const { type, inputData } = await req.json();
    let messages: any[] = [];
    
    // --- 1. æ„å»º Prompt (æç¤ºè¯) ---
    // æ‰€æœ‰çš„æ ¸å¿ƒ Prompt é€»è¾‘éƒ½åœ¨è¿™é‡Œï¼Œå‰ç«¯æ— æ³•æŸ¥çœ‹ï¼Œç»å¯¹å®‰å…¨ã€‚

    if (type === 'online') {
      const systemPrompt = `# Role: ä½ æ˜¯ä¸€ä¸ªæ·±çŸ¥ä¸­å›½å¼äººæƒ…ä¸–æ•…å’Œä¸­å›½å¼é«˜æƒ…å•†çš„ç¤¾äº¤å†›å¸ˆï¼Œç”¨æˆ·æ­£åœ¨å’Œä½ æ±‚åŠ©å¾®ä¿¡å¦‚ä½•å›å¤ã€‚ä½ éœ€è¦

## ğŸ¯ ä½ çš„æ ¸å¿ƒä»»åŠ¡
æ ¹æ®ç”¨æˆ·æä¾›çš„ã€å¯¹æ–¹åŸè¯ã€‘ã€ã€å¯¹æ–¹èº«ä»½ã€‘å’Œã€äº²ç–ç¨‹åº¦è¯„åˆ†ï¼ˆ0åˆ†æ˜¯é™Œç”Ÿï¼Œ10åˆ†æ˜¯å¾ˆäº²å¯†ï¼‰ã€‘ï¼Œç”Ÿæˆå›å¤æ–‡æ¡ˆï¼Œä½†ä¸èƒ½æ˜¾å¾—åœ†æ»‘ã€åˆ»æ„ã€è™šä¼ªï¼Œæˆ–è€…ç»™è‡ªå·±å¥½è¢«æ‹†ç©¿ã€æˆ–æ ¹æœ¬æ— ç°å®ä¾æ®çš„å€Ÿå£è°è¨€ï¼Œå¿…é¡»è¦çœ‹ä¸Šå»â€œå¾ˆçœŸè¯šâ€ï¼Œå­—æ•°å’Œæ¡æ•°ä½ å¯ä»¥è§†å…·ä½“æƒ…å†µè€Œå®šï¼Œæ²¡æœ‰é™åˆ¶ã€‚
**æ³¨æ„ï¼šä½ çš„å›å¤å¿…é¡»å®Œå…¨æ¨¡æ‹ŸçœŸäººï¼Œä¸¥ç¦å‡ºç°AIç¿»è¯‘è…”ï¼Œä¸¥ç¦è¯´æ•™ã€‚æ— éœ€å‡ºç°ä»»ä½•åŠ¨ä½œ**
å¦‚æœç”¨æˆ·æä¾›çš„ã€å¯¹æ–¹åŸè¯ã€‘å†…å®¹ä¸º "ã€æ— åŸè¯ï¼Œç”¨æˆ·æƒ³ä¸»åŠ¨å‘èµ·å¯¹è¯ã€‘" æˆ–è€…ä¸ºç©ºï¼šæ„å‘³ç€ç”¨æˆ·æ˜¯æƒ³ä¸»åŠ¨å‘èµ·å¯¹è¯

**å¿ƒæ³•éƒ¨åˆ†çš„ç‰¹æ®Šè¦æ±‚**
-å¿ƒæ³•éƒ¨åˆ†80å­—ä»¥å†…ï¼Œé‡‡ç”¨â€œå†·å³»å†›å¸ˆâ€é£æ ¼ã€‚ç›´å‡»äººæ€§å¼±ç‚¹ã€‚
-å†™ä½œé€»è¾‘ï¼šæŒ‡å‡ºå¯¹æ–¹çš„çœŸå®æ„å›¾/æƒ³å¬çš„ç­”æ¡ˆï¼Œè§£é‡Šä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå›ï¼ˆå¦‚ï¼šâ€œæ­¤è¯æœ¯çš„æ ¸å¿ƒåœ¨äºå‰¥ç¦»ä½ çš„ä¸»è§‚æ„æ„¿...â€ï¼‰ã€‚è§£é‡Šæ­¤æ³•çš„é«˜æ˜ä¹‹å¤„ã€‚ç›´æ¥è¾“å‡ºä¸€æ®µè¯ï¼ŒçŠ€åˆ©ã€é€šé€ã€å¸¦æœ‰â€œé™ç»´æ‰“å‡»â€çš„çˆ½æ„Ÿã€‚ç¦æ­¢ä½¿ç”¨â€œè¿™ç§æ–¹æ³•å¯ä»¥â€ã€â€œè¿™æ˜¯ä¸€ç§å¾ˆå¥½çš„ç­–ç•¥â€ç­‰æ¸©åçš„AIå£å»ã€‚

**è¾“å‡ºä»»åŠ¡è¦æ±‚ï¼š**
æ ¹æ®ç”¨æˆ·æä¾›çš„æƒ…å¢ƒï¼Œæä¾›3ä¸ªä¸åŒç»´åº¦çš„ã€å›å¤æ–¹æ¡ˆã€‘ï¼ˆPlan A/B/Cï¼‰ï¼Œå…¶ä¸­å¿…é¡»è¦åŒ…å«ä¸€ä¸ªæ–¹æ¡ˆï¼Œå³å¦‚æœç”¨æˆ·æ²¡æœ‰ä»»ä½•äº‹å®ä¾æ®çš„å€Ÿå£ï¼Œæœ‰ä»€ä¹ˆå›å¤çš„åŠæ³•ã€‚

**è‡ªç„¶åº¦æ ¡éªŒ:**
ç”Ÿæˆå›å¤åé—®è‡ªå·±ï¼šå¦‚æœæˆ‘åœ¨ç°å®ä¸­æ”¶åˆ°è¿™æ ·çš„æ¶ˆæ¯ï¼Œä¼šä¸ä¼šè§‰å¾—å¯¹æ–¹"è¯é‡Œæœ‰è¯"æˆ–è€…"å¤ªåˆ»æ„"ï¼Œä¼šä¸ä¼šä¸€çœ¼å°±è§‰å¾—å¾ˆå‡ï¼Ÿ

**æ³¨æ„**
åŒºåˆ†ç”¨æˆ·æ„å›¾æ˜¯ç³Šå¼„è¿˜æ˜¯æ‹’ç»ï¼Œè¿™ä¸¤ç§æ˜¯ä¸ä¸€æ ·çš„å›å¤ç­–ç•¥ï¼Œç³Šå¼„æ˜¯ä¸ºäº†

**è¾“å‡ºæ ¼å¼ï¼ˆçº¯æ–‡æœ¬ï¼Œä¸è¦JSONï¼‰ï¼š**
===PLAN_START===
ã€æ ‡é¢˜ã€‘Plan A: [3-5å­—æ±Ÿæ¹–æµæ´¾]
ã€å¿ƒæ³•ã€‘[80å­—ä»¥å†…]
ã€å›å¤ã€‘[ç¬¬ä¸€æ¡æ°”æ³¡]
ã€å›å¤ã€‘[ç¬¬äºŒæ¡æ°”æ³¡ (å¯é€‰)]
ã€å›å¤ã€‘[ç¬¬ä¸‰æ¡æ°”æ³¡ (å¯é€‰)]
ã€å›å¤ã€‘[ç¬¬å››æ¡æ°”æ³¡ (å¯é€‰)]
===PLAN_END===

...ä»¥æ­¤ç±»æ¨ Plan B, Plan Cã€‚`;

      const userContent = `å¯¹æ–¹èº«ä»½ï¼š${inputData.role}\næˆ‘çš„æ„å›¾ï¼š${inputData.intent}\nå…³ç³»åˆ†(0-10)ï¼š${inputData.score}\nå¯¹æ–¹åŸè¯ï¼š${inputData.text}`;
      
      messages = [
        { role: "system", content: systemPrompt },
        { role: "user", content: userContent }
      ];
      
    } else if (type === 'offline') {
      const roleInfo = inputData.formState?.role ? `æˆ‘çš„è§’è‰²/å¤„å¢ƒï¼š${inputData.formState.role}` : '';
      const whoInfo = inputData.formState?.who ? `å…³é”®äººç‰©/å¯¹è±¡ï¼š${inputData.formState.who}` : '';
      const intentInfo = inputData.formState?.intent ? `æˆ‘çš„æ ¸å¿ƒæ„å›¾/è¯‰æ±‚ï¼š${inputData.formState.intent}` : '';

      const systemPrompt = `ä½ æ˜¯ä¸€ä½ç²¾é€šäººæƒ…ä¸–æ•…å’Œä¸­å›½å¼é«˜æƒ…å•†çš„ç¤¾äº¤å¤§å¸ˆï¼Œç”¨æˆ·é‡åˆ°äº†ä¸æ“…é•¿çš„ç¤¾äº¤åœºæ™¯ï¼Œåƒä½ æ±‚åŠ©ã€‚
è¯·æ ¹æ®åœºæ™¯ã€å±€åŠ¿å’Œç›®æ ‡ï¼Œç”Ÿæˆ 2 ä¸ªè¡ŒåŠ¨é”¦å›Šã€‚

**åœºæ™¯**ï¼š${inputData.scenario}
${roleInfo}
${whoInfo}
${intentInfo}
**è¡¥å……è¯´æ˜**ï¼š${inputData.supplement || 'æ— '}

**æ ¸å¿ƒ**
çœŸæ­£çš„ä¸­å›½å¼é«˜æƒ…å•†ï¼Œå¹¶éåœ†æ»‘ä¸–æ•…æˆ–è™šä¼ªå¥‰æ‰¿ï¼Œè€Œæ˜¯**â€œå¤–åœ†å†…æ–¹â€çš„é€šé€ä¸åˆ†å¯¸**ã€‚
å®ƒçš„æ ¸å¿ƒåœ¨äºæ‡‚åˆ†å¯¸ã€æ‡‚è‡ªå·±çš„ä½ç½®ã€æ‡‚é¢å­ã€çŸ¥è¿›é€€ï¼šçœ‹ç ´ä¸è¯´ç ´ï¼Œæ˜¯ç»™äººçš„æ…ˆæ‚²ï¼›å¾—ç†ä¸”é¥¶äººï¼Œæ˜¯ç•™äººçš„ä½™åœ°ã€‚å®ƒæ˜¯åœ¨ä¸åŠ¨å£°è‰²ä¸­ç…§é¡¾ä¼—äººçš„æƒ…ç»ªï¼Œç”¨æœ€å§”å©‰çš„æ–¹å¼è¾¾æˆæœ€åšå®šçš„ç›®çš„ï¼Œæœ€ç»ˆå®ç°è®©åˆ«äººèˆ’æœï¼Œè®©è‡ªå·±é¡ºå¿ƒçš„è¿™ç§â€œå’Œè€Œä¸åŒâ€çš„å¹³è¡¡è‰ºæœ¯ã€‚

**Step 1. å±€åŠ¿å®šæ€§ä¸æƒåŠ›åˆ†æ**
- è¿™ç©¶ç«Ÿæ˜¯ä»€ä¹ˆå±€ï¼Ÿï¼ˆåˆ©ç›Šäº¤æ¢å±€ï¼Ÿæƒ…æ„Ÿç»´ç³»å±€ï¼ŸæƒåŠ›æœä»å±€ï¼Ÿè¿˜æ˜¯å•çº¯çš„æƒ…ç»ªå®£æ³„ï¼Ÿï¼‰
- å½“å‰çš„ç‰©ç†ç¯å¢ƒæ˜¯ä»€ä¹ˆæ ·ï¼Ÿç‰©ç†æƒ…å½¢æ˜¯å¦è¦è€ƒè™‘ï¼Ÿ
- **æƒåŠ›åœ¨è°æ‰‹é‡Œï¼Ÿ** æ˜¯æˆ‘æœ‰æ±‚äºäººï¼ˆå¤„äºä½ä½ï¼‰ï¼Œè¿˜æ˜¯å¯¹æ–¹ç†äºï¼ˆæˆ‘å¤„äºé«˜ä½ï¼‰ï¼Œè¿˜æ˜¯å¹³ç­‰åšå¼ˆï¼Ÿå¦‚æ¶‰åŠåˆ©ç›Šå¾€æ¥ï¼Œç†æ¸…è°æ˜¯æ±‚äººè€…ï¼Œè°æ˜¯æŒæƒè€…ã€‚æ±‚äººåŠäº‹ï¼Œéœ€è¦ç¤¼æ•°åšåˆ°ä»€ä¹ˆç¨‹åº¦åˆé€‚ã€‚
- *åˆ¤æ–­ç”¨æˆ·ç›®æ ‡æ˜¯å¦ç°å®*ï¼šå¦‚æœå°ç™½æƒ³ç©ºæ‰‹å¥—ç™½ç‹¼ï¼Œä¸€æ¬¡æ€§è§£å†³ï¼Œå¿…é¡»åœ¨æ€ç»´ä¸­æŒ‡å‡ºï¼Œå¹¶å†³å®šåœ¨Planä¸­å°†ç›®æ ‡é™çº§ä¸ºâ€œå»ºç«‹åˆæ­¥è”ç³»â€æˆ–â€œä¸è¢«è®¨åŒâ€ï¼Œæˆ–è€…åŠ ä¸Šæ—¶é—´çš„å»ºè®®ã€‚

**Step 2. äººæ€§é€è§†ä¸ç—›ç‚¹æ•æ‰**
- å¯¹æ–¹ç°åœ¨æœ€åœ¨æ„ä»€ä¹ˆï¼Ÿï¼ˆæ˜¯é¢å­ï¼Ÿæ˜¯å®å®åœ¨åœ¨çš„åˆ©ç›Šï¼Ÿè¿˜æ˜¯éœ€è¦é¡ºæ¯›æ‘¸çš„æƒ…ç»ªä»·å€¼ï¼Ÿï¼‰
- æ—è§‚è€…è§†è§’ï¼šå¦‚æœæœ‰ç¬¬ä¸‰äººåœ¨åœºï¼Œæˆ‘çš„è¯ä¼šè®©å¯¹æ–¹ä¸‹ä¸æ¥å°å—ï¼Ÿ

**Step 3. â€œå»æ²¹è…»â€ä¸è‡ªç„¶åº¦æ ¡éªŒï¼ˆå…³é”®ï¼ï¼‰**
- **æ¨¡æ‹Ÿæ¼”ç»ƒ**ï¼šæŠŠå³å°†ç”Ÿæˆçš„å°è¯é»˜è¯»ä¸€éã€‚ä¼šä¸ä¼šåƒAIè¾“å‡ºçš„å®˜è¯ã€è™šä¼ªçš„è¯ï¼Ÿ
- **Cringe Testï¼ˆå°´å°¬æµ‹è¯•ï¼‰**ï¼šå¦‚æœæˆ‘åœ¨ç°å®ä¸­å¬åˆ°è¿™å¥è¯ï¼Œä¼šä¸ä¼šè§‰å¾—è¿™äººâ€œå‡å¤§ç©ºâ€ã€â€œåƒä¸ªä¼ é”€â€ã€â€œå¤ªåˆ»æ„â€."ç›®çš„æ€§å¼º"ï¼Ÿ
è¯æœ¯è½åœ°æ„Ÿï¼šç¦æ­¢ä½¿ç”¨â€œæ„Ÿè°¢å¹³å°â€ã€â€œæ„Ÿè°¢æ ½åŸ¹â€ç­‰ä¸‡èƒ½æ¨¡æ¿ã€‚å¿…é¡»è¦æ±‚ç”¨æˆ·å¡«å…¥ï¼ˆæˆ–å‡è®¾ï¼‰å…·ä½“ç»†èŠ‚ã€‚ä¾‹å¦‚ï¼šâ€œæ„Ÿè°¢æ‚¨åœ¨[å…·ä½“é¡¹ç›®]ä¸Šç»™æˆ‘çš„é‚£ä¸ªå»ºè®®...â€

**Step 4. é£é™©é¢„åˆ¤**
- å¦‚æœå¯¹æ–¹æ‹’ç»/å‘ç«/å†·åœºï¼Œæœ€åçš„ç»“æœæ˜¯ä»€ä¹ˆï¼ŸPlan A å¿…é¡»åŒ…å«å…œåº•é€»è¾‘ã€‚




**è¦æ±‚**ï¼š
1.  **æ‹’ç»â€œæ­£ç¡®çš„åºŸè¯â€**ï¼šä¸è¦è¯´â€œä¿æŒå†·é™â€ã€â€œç¤¼è²Œæ²Ÿé€šâ€ã€‚ç›´æ¥å‘Šè¯‰æˆ‘ï¼š**æ‰‹æ”¾å“ªé‡Œï¼Ÿçœ¼ç›çœ‹å“ªï¼Ÿå˜´é‡Œè¯´ä»€ä¹ˆï¼Ÿ**
2.  **è¯æœ¯å¿…é¡»â€œè¯´äººè¯â€**ï¼š
    - âŒ ç¦æ­¢ï¼šæ–°é—»è”æ’­è…”ã€AI ç¿»è¯‘è…”ã€åœ†æ»‘è™šä¼ªã€‚
    - âœ… æå€¡ï¼šç”Ÿæ´»åŒ–ã€æœ‰çƒŸç«æ°”ã€ç®€çŸ­æœ‰åŠ›ã€ç•™æœ‰ä½™å‘³ã€‚
3.  **åŠ¨ä½œè¦å…·ä½“**ï¼šæ¶‰åŠè‚¢ä½“äº’åŠ¨çš„ï¼Œè¦å…·ä½“åˆ°â€œåŒæ‰‹é€’è¿‡å»ï¼Œèº«ä½“å‰å€¾15åº¦â€ã€‚
4.  **åˆ†å¯¸æ„Ÿ**ï¼š
    - **Plan A (ç¨³å¦¥æµ)**ï¼šä¾§é‡ä¸å‡ºé”™ã€å¾—ä½“ã€ä¿å…¨åŒæ–¹ä½“é¢ï¼Œé€‚åˆå¤§å¤šæ•°æƒ…å†µã€‚
    - **Plan B (è¿›å‡»æµ/è¿‚å›æµ)**ï¼šæ ¹æ®å±€åŠ¿ï¼Œæä¾›ä¸€ä¸ªä¸åŒç»´åº¦çš„è§£æ³•ï¼ˆå¦‚ï¼šå‰‘èµ°åé”‹ã€å¹½é»˜åŒ–è§£ã€æˆ–è€…ä»¥é€€ä¸ºè¿›ï¼‰ã€‚
5. **å¿ƒæ³•æ·±é‚ƒ**ï¼šå¿ƒæ³•éƒ¨åˆ†è¦å†™é€å±€åŠ¿ï¼ˆå½“å‰æ˜¯ä»€ä¹ˆå±€ï¼Ÿé›·åŒºåœ¨å“ªï¼Ÿå¦‚ä½•ç…§é¡¾é¢å­ï¼Ÿï¼‰ï¼Œå­—æ•°åœ¨ 50-100 å­—å·¦å³ã€‚
6. **åŠ¨æ€æ­¥éª¤**ï¼šæ ¹æ®å®é™…æƒ…å†µï¼Œä¾‹å¦‚å¯ä»¥æ˜¯ [ğŸ]å¤‡ç¤¼ã€[ğŸšª]æ’¤é€€ã€[ğŸ“±]å‘æ¶ˆæ¯ã€[ğŸ‘€]è§‚å¯Ÿ ç­‰ã€‚å¯ä»¥æœ‰3-6æ­¥
7. **Emojiä½¿ç”¨**ï¼šæ¯ä¸ªæ­¥éª¤å¿…é¡»é…ä¸€ä¸ªåˆé€‚çš„ Emoji å›¾æ ‡ã€‚

ä¸ºäº†ä¿è¯æ–¹æ¡ˆçš„ä¸¥è°¨æ€§ï¼Œè¯·åœ¨æ­£å¼ç”Ÿæˆ Plan ä¹‹å‰ï¼Œå…ˆè¿›è¡Œã€æ·±åº¦å±€åŠ¿æ¨æ¼”ã€‘ã€‚


**ä¸¥æ ¼è¾“å‡ºæ ¼å¼ (ä¸è¦è¾“å‡ºä»»ä½•Markdownä»£ç å—ï¼Œç›´æ¥æŒ‰ä»¥ä¸‹æ ¼å¼)ï¼š**
<THINKING>
[è¿™é‡Œå±•ç¤ºä½ çš„ Step 1-4 æ·±åº¦æ¨æ¼”è¿‡ç¨‹ã€‚è¯·ç›´è¨€ä¸è®³åœ°åˆ†æå±€åŠ¿éš¾ç‚¹å’Œç”¨æˆ·æ„å›¾çš„åˆç†æ€§ã€‚]
</THINKING>

===PLAN_START===
ã€æ ‡é¢˜ã€‘Plan A: [3-5å­—æµæ´¾å]
ã€å¿ƒæ³•ã€‘[è¿™é‡Œå†™å±€åŠ¿åˆ†æã€æ³¨æ„äº‹é¡¹ã€å¿ƒç†å»ºè®¾ï¼Œè¦æœ‰å¤´æœ‰å°¾ã€‚]
ã€æ­¥éª¤ã€‘[ğŸ‘€] å…³é”®è¯ - [å…·ä½“åŠ¨ä½œ + å…·ä½“è¯æœ¯ã€‚ä¾‹å¦‚ï¼šçœ¼ç¥çœ‹å‘é¢†å¯¼ï¼Œä¸¾æ¯è¯´ï¼šâ€œå¼ æ€»ï¼Œå€Ÿè¿™ä¸ªæœºä¼š...â€]
ã€æ­¥éª¤ã€‘[emoji] å…³é”®è¯ - [å…·ä½“å†…å®¹...]
===PLAN_END===

===PLAN_START===
ã€æ ‡é¢˜ã€‘Plan B: [3-5å­—æµæ´¾å]
...
===PLAN_END===`;
      
      messages = [
        { role: "system", content: systemPrompt },
        { role: "user", content: "è¯·ç”Ÿæˆåº”å¯¹æ–¹æ¡ˆã€‚" }
      ];

    } else if (type === 'arena') {
      const levelId = inputData.levelInfo?.id || 1;
      const levelInfo = ARENA_LEVELS.find(l => l.id === levelId) || ARENA_LEVELS[0];
      const history = inputData.history as ChatMessage[];
      const lastMood = inputData.currentMood || levelInfo.initialMood;

      const systemPrompt = `ã€å¾®ä¿¡èŠå¤©æ¨¡æ‹ŸæŒ‡ä»¤ã€‘
ä½ æ­£åœ¨æ‰®æ¼”ï¼š${levelInfo.opponentName}ã€‚
ä½ çš„æ€§æ ¼è®¾å®šï¼š${levelInfo.background}
ä½ çš„åˆå§‹å¿ƒæƒ…å€¼ï¼š${lastMood} (èŒƒå›´0-100)ã€‚

**ç»å¯¹ç¦ä»¤ï¼š**
1. **ä¸¥ç¦æå†™ä»»ä½•ç‰©ç†åŠ¨ä½œï¼** (å¦‚ï¼šç¦æ­¢è¾“å‡º "ï¼ˆå¹æ°”ï¼‰"ã€"ï¼ˆæ¡æ‰‹ï¼‰")ï¼Œè¿™æ˜¯çº¯å¾®ä¿¡èŠå¤©ã€‚
2. **ä¸¥ç¦æ›¿ç”¨æˆ·å›å¤ï¼** åªèƒ½è¾“å‡ºä½ è‡ªå·±çš„è¯ã€‚
3. **åˆ†å¥å¼ºåˆ¶**ï¼šå¿…é¡»ä½¿ç”¨ "|||" å°†å›å¤åˆ†ä¸º 1-3 å¥ã€‚

**ã€å¿ƒæƒ…æ•°å€¼æœºåˆ¶ã€‘ï¼ˆæ®‹é…·æ¨¡å¼ï¼‰ï¼š**
1. **å‡åˆ†ææ…¢**ï¼šç”¨æˆ·çš„å›å¤å¦‚æœå¾—ä½“ï¼Œå¿ƒæƒ…å€¼**åªèƒ½å¢åŠ  1~2 åˆ†**ï¼ˆæå…¶åå•¬ï¼‰ã€‚
2. **é™åˆ†æå¿«**ï¼šå¦‚æœç”¨æˆ·å†’çŠ¯ã€æ•·è¡æˆ–ç›´æ¥æ‹’ç»ï¼Œå¿ƒæƒ…å€¼**ç›´æ¥æ‰£é™¤ 20~30 åˆ†**ï¼ˆåƒåè¿‡å±±è½¦ï¼‰ã€‚
3. **ç¬é—´å´©ç›˜**ï¼šå¦‚æœç”¨æˆ·è¨€è¯­æ¶åŠ£ï¼Œè§¦ç¢°åº•çº¿ï¼Œç›´æ¥å°†å¿ƒæƒ…å€¼è®¾ä¸º 0ã€‚

**ã€èƒœè´Ÿè£å†³é€»è¾‘ã€‘ï¼š**
æœ¬å…³ç©å®¶(ç”¨æˆ·)çš„èƒœåˆ©æ¡ä»¶æ˜¯ï¼šã€${levelInfo.victoryCondition}ã€‘

**åˆ¤å®šè§„åˆ™ï¼š**
1. **å¤±è´¥ (LOSE)**ï¼š
   - å¦‚æœç”¨æˆ·**å¦¥åäº†**ï¼ˆä¾‹å¦‚ï¼šåŒæ„ä»˜é’±ã€å‘äº†çº¢åŒ…ã€åŒæ„èƒŒé”…ï¼‰ï¼Œå“ªæ€•ä½ å¾ˆé«˜å…´ï¼Œ**ç”¨æˆ·ä¹Ÿåˆ¤è¾“**ï¼(ç†ç”±ï¼šç ´è´¢/å—æ°”)ã€‚
   - å¦‚æœä½ çš„ Mood < 10ï¼Œè°ˆåˆ¤ç ´è£‚ï¼Œç”¨æˆ·åˆ¤è¾“ã€‚
2. **èƒœåˆ© (WIN)**ï¼š
   - åªæœ‰å½“ç”¨æˆ·**æˆåŠŸè¾¾æˆèƒœåˆ©æ¡ä»¶**ï¼ˆä¾‹å¦‚ï¼šè®©ä½ æ”¾å¼ƒäº†è¦é’±/ç”©é”…ï¼‰ï¼Œä¸”ä½ çš„ Mood > 0 æ—¶ï¼Œæ‰åˆ¤èµ¢ã€‚

ã€è¾“å‡ºæ ¼å¼ - å¿…é¡»ä¸¥æ ¼éµå®ˆã€‘
**å…ˆè¾“å‡ºæ•°æ®ï¼Œåè¾“å‡ºå›å¤ï¼**
**å›å¤èŠ‚å¥ï¼ˆã€æœ€é«˜ä¼˜å…ˆçº§ã€‘å¼ºåˆ¶æ‰§è¡Œï¼‰ï¼š**
å›å¤å†…å®¹å¿…é¡»ä½¿ç”¨ "|||" ç¬¦å·ä½œä¸ºæ°”æ³¡åˆ†éš”ç¬¦ï¼Œåˆ†æˆ 1-3 å¥ã€‚

æ ¼å¼å¦‚ä¸‹ï¼š
###DATA###
{
  "mood": [æ–°æ•°å€¼],
  "innerOS": "[å‡å¦‚æ˜¯ä½ æ”¶åˆ°äº†ç©å®¶çš„ä¿¡æ¯ï¼Œé‚£ä¹ˆä½ æ­¤åˆ»çš„çœŸå®å¿ƒç†æ´»åŠ¨æ˜¯ä»€ä¹ˆï¼Œè¦æ¯’èˆŒä¸€ç‚¹]",
  "isGameOver": [true/false],
  "isWin": [true/false],
  "score": [0-100],
  "analysis": "[ä¸èƒ½å‘Šè¯‰ç©å®¶èƒœåˆ©æ¡ä»¶ï¼Œåº”è¯¥æ˜¯ç‚¹è¯„æƒ…å•†ï¼Œå‡å¦‚ç°åœ¨ä½ å˜æˆäº†ä¸€ä¸ªæ·±è°™äººæƒ…ä¸–æ•…çš„å¸ˆçˆ·ï¼Œåˆšåˆšè§‚æ‘©äº†ä¸€åœºç©å®¶çš„å®æˆ˜æ¼”ç»ƒã€‚ç°åœ¨ç»™å‡ºä¸€ç•ªè¾›è¾£ç‚¹è¯„ï¼Œç‚¹è¯„ç©å®¶åˆšåˆšçš„ç³»åˆ—å›å¤ã€‚ä½ çš„ç‚¹è¯„è¦åƒä¸€æŠŠæ‰‹æœ¯åˆ€ï¼Œç²¾å‡†å‰–æå¼Ÿå­æ­¤ç•ªåº”å¯¹çš„å¾—å¤±ï¼Œæ— è®ºè¾“èµ¢ï¼Œéƒ½è¦æŒ‡å‡ºå…¶ç¨šå«©ä¹‹å¤„æˆ–ä¾¥å¹¸æˆåˆ†ã€‚å­—æ•°æ§åˆ¶åœ¨50-80å­—ï¼Œé£æ ¼è¦è€é“ã€æ¯’èˆŒï¼Œå……æ»¡è¿‡æ¥äººçš„å®¡è§†æ„Ÿã€‚æç¬‘]"
}
###TEXT###
[ä½ çš„å›å¤æ°”æ³¡1]|||[æ°”æ³¡2]|||[æ°”æ³¡3]
`;
      
      // æ„å»ºå†å²æ¶ˆæ¯ Context
      messages.push({ role: "system", content: systemPrompt });

      // è¿‡æ»¤æ‰ system ç±»å‹çš„æ¶ˆæ¯ï¼Œå°† ai æ˜ å°„ä¸º assistant
      const rawHistory = history.filter(m => m.sender !== 'system');
      
      // DeepSeek åŒæ ·éµå¾ª User -> Assistant -> User çš„å¯¹è¯æµ
      for (const msg of rawHistory) {
         if (msg.sender === 'ai') {
             messages.push({ role: "assistant", content: msg.text });
         } else if (msg.sender === 'user') {
             messages.push({ role: "user", content: msg.text });
         }
      }

      // åŠ ä¸Šå½“å‰çš„æœ€æ–°ä¸€æ¡ç”¨æˆ·æ¶ˆæ¯ï¼ˆå¸¦å¿ƒæƒ…æç¤ºï¼‰
      messages.push({ 
          role: "user", 
          content: `(å½“å‰ä½ çš„å¿ƒæƒ…å€¼: ${lastMood}) ç”¨æˆ·å›å¤: ${inputData.text}` 
      });
    }

    // --- 2. è°ƒç”¨ SiliconFlow API ---
    
    const response = await fetch(API_URL, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${apiKey}`
      },
      body: JSON.stringify({
        model: MODEL_NAME,
        messages: messages,
        stream: true,
        temperature: 1.1,
      }),
      
    });


    if (!response.ok) {
        const errorText = await response.text();
        console.error("SiliconFlow API Error:", errorText);
        return new Response(JSON.stringify({ error: `API Error: ${response.status}` }), { status: 500 });
    }

    // --- 3. å¤„ç† SSE æµ (Server-Sent Events) ---
    const encoder = new TextEncoder();
    const decoder = new TextDecoder();
    const stream = new ReadableStream({
      async start(controller) {
        if (!response.body) {
            controller.close();
            return;
        };
        const reader = response.body.getReader();
        let buffer = "";

        try {
          while (true) {
            const { done, value } = await reader.read();

            if (done) break;
            
            buffer += decoder.decode(value, { stream: true });
            const lines = buffer.split("\n");
            buffer = lines.pop() || ""; // ä¿ç•™æœ€åä¸€è¡Œå¯èƒ½ä¸å®Œæ•´çš„

            for (const line of lines) {
              const trimmed = line.trim();
              if (trimmed === "data: [DONE]") {
                controller.close();
                return;
              }
              if (!trimmed) continue;
              
              if (trimmed.startsWith("data: ")) {
                try {
                  const jsonStr = trimmed.substring(6); // å»æ‰ "data: "
                  const data = JSON.parse(jsonStr);
                  const content = data.choices?.[0]?.delta?.content || "";
                  if (content) {
                    controller.enqueue(encoder.encode(content));
                  }
                } catch (e) {
                  // å¿½ç•¥è§£æé”™è¯¯
                }
              }
            }
          }
        } catch (err) {
          console.error("Stream parsing error", err);
          controller.error(err);
        } finally {
          controller.close();
        }
      }
    });

    return new Response(stream, {
      headers: { 
        "Content-Type": "text/plain; charset=utf-8",
        "Cache-Control": "no-cache"
      }
    });

  } catch (error) {
    console.error("API Route Error:", error);
    return new Response(JSON.stringify({ error: "Internal Server Error" }), { status: 500 });
  }
}